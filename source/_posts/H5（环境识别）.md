---
title: H5 判断当前环境
data: 2022-10-12 18:00
tags: H5
---

H5 可能在微信小程序、微信浏览器，安卓、ios应用，支付宝小程序、支付宝浏览器，判断webview的环境走对应的逻辑

<!-- more -->

<font color="#08c">1.navigator.userAgent获取信息识别所处环境（是无法精细获取到的，需要例如微信生态有小程序、内置浏览器）</font>
<font color="#08c">2.微信需要引入SDK配置、微信config调用window.wx.miniProgram.getEnv方法识别;</font>
<font color="#08c">3.APP需要原生提供能力才能从userAgent塞信息、h5才能从中获取对应的信息，假如没有userAgent信息，就只能通过jsBrige调用APP提供的空方法，h5通过 try / catch 语法捕获识别;</font>
<font color="#08c">4.支付宝本身window.onload以后，容器会初始化，产生一个全局变量AlipayJSBridge, 我们可以直接使用</font>

#### 识别环境方法的封装
```js
/***
 * 判断当前环境
 * @returns [string]可能值 ali / aliApplet / wx / wxApplet / iosApp / androidApp / other
 ***/
export const osType = () => {
  var userAgent = window.navigator.userAgent.toLowerCase();
  if (userAgent.match(/Alipay/i) == "alipay") {
    return new Promise((resolve) => {
      window.wx.miniProgram.getEnv(function (res) {
        /*  
            支付宝跟微信有所区别
            window.onload以后，容器会初始化，产生一个全局变量AlipayJSBridge, 我们可以直接使用
            暂时有卡点，后续补充
        */
        if (res.miniprogram) {
          // console.log("支付宝小程序 ---- aliApplet");
          resolve("aliApplet");
        } else {
          // console.log("支付宝浏览器 ---- ali");
          resolve("ali");
        }
      });
    });
  } else if (userAgent.match(/MicroMessenger/i) == "micromessenger") {
    return new Promise((resolve) => {
      initScript(() => {
        window.wx.miniProgram.getEnv(function (res) {
        // window.wx.miniProgram.getEnv 判断是在微信小程序 true、还是在微信浏览器 false
          if (res.miniprogram) {
            // console.log("微信小程序 ---- wxApplet");
            resolve("wxApplet");
          } else {
            // console.log("微信浏览器 ---- wx");
            resolve("wx");
          }
        });
      });
    });
  } else if (userAgent.match(/ensd/i) == "ensd") {
    /* 
        判断app需要同事提供这个userAgent获取信息的能力
        假如没有，就只能通过，只能通过jsBrige，调用app提供的空方法，没有这个方法就会报错，我们可以捕获异常从而达到环境的判断
        try / catch
    */
    if (os == "ios") {
      // console.log("app环境 ---- 苹果app");
      return "iosApp";
    }
    if (os == "android") {
      // console.log("app环境 ---- 安卓app");
      return "androidApp";
    }
  } else {
    // console.log("通用浏览器")
    return "other";
  }
};


/***
 * 判断当前运行环境
 * @returns [string]可能值 ios / android / pc / other
 * */
export const os = (function () {
  var ua = navigator.userAgent.toLowerCase();
  return /(?:iphone|ipad|ipod)/.test(ua)
    ? "ios"
    : /(?:android|adr )/.test(ua)
    ? "android"
    : !/mobile/.test(ua)
    ? "pc"
    : "other";
})();
```