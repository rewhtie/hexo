---
title: 文件上传
tag: 全局函数
categories: 函数
---

常用的功能：文件上传

<!-- more -->
#### 一、文件上传 .js

```js
import md5 from 'js-md5'
import axios from 'axios'

/**
 * 组合使用
 * @param { Object } config  判断条件回调
 * config {
 *  api: 接口请求
 *  before：上传之前的配置
 *  accept：限制文件格式
 * }
 * @return { String }
 */
export const uploadFileEvent = config => {
 return new Promise((resolve, reject) => {
	const input = document.createElement('input')
	input.style = {
	 color: 'red'
	}
	input.type = 'file'
	if (config.accept) {
	 input.accept = config.accept
	}
	input.onchange = async () => {
	 const file = input.files[0]
	 let flag = await beforeUpload(file, config?.before)
	 if (flag) {
		if (config?.api) {
		 let data = await httpRequest(file, config.api)
		 resolve(data)
		} else {
		 resolve(file)
		}
	 }
	}
	input.oncancel = () => {
	 reject()
	 throw new Error('取消上传')
	}
	input.onerror = () => {
	 reject()
	 throw new Error('上传出错~')
	}
	input.click()
 })
}

/**
 * url链接展示文件墙
 * @param { Array } fileUrl url链接数组
 * @return { Array<Object> } 数组
 */
export const fileUrlToBase64 = fileUrl => {
 return fileUrl.map(item => {
	let filename = item.split('/')?.pop() || '*' // 从 URL 中获取文件名
	let blobUrl = URL.createObjectURL(new Blob([''], { type: '' })) // 创建一个 Blob 对象并获取 URL
	return {
	 name: filename,
	 url: blobUrl
	}
 })
}
/**
 * 上传之前的校验
 * @param { String, Object } file params  二进制 | 回调
 * params：{
 *  suceessCallback：校验成功之后的回调
 *  errorCallback：失败回调
 *  doneCallback：完成回调
 *  maxSize：文件大小
 * }
 * @return { Boolean }
 */
export const beforeUpload = async (file, params = {}) => {
 const defaultParams = {
	maxSize: 2000,
	suceessCallback: () => {
	 return new Promise(resolve => {
		resolve(`成功`)
	 })
	},
	errorCallback: () => {
	 return new Promise(resolve => {
		resolve(`上传图片大小不能超过${2000}KB!`)
	 })
	},
	doneCallback: () => {
	 return new Promise(resolve => {
		resolve(`完成`)
	 })
	}
 }
 const { maxSize, suceessCallback, errorCallback, doneCallback } = Object.assign(params, defaultParams)
 let flag
 if (file.size / 1024 > maxSize) {
	errorCallback && (await errorCallback())
	flag = false
 } else {
	suceessCallback && (await suceessCallback())
	flag = true
 }
 doneCallback && doneCallback()
 return flag
}
/**
 *
 * @param { String } file  二进制
 * @return { Promise }
 */
export function readBlobAsArrayBuffer(file) {
 return new Promise(resolve => {
	const reader = new window.FileReader()
	reader.onload = event => resolve(event.target.result)
	reader.readAsArrayBuffer(file)
 })
}
/**
 * 上传方法
 * @param { String } file  二进制
 * @return { Promise }
 */
export const httpRequest = async (file, api) => {
 let rf = await readBlobAsArrayBuffer(file)
 const MD5 = md5(rf)
 const data = await api({
	file_key: 'file',
	filename: file.name,
	hash: MD5,
	mime_type: file.type,
	size: file.size,
	storage: {
	 channel: 'public'
	}
 })
 let fileUrl
 if (file.size / 1024 > 2000) {
	let form = new FormData()
	form.append('file', file.file)
	fileUrl = await uploadFileForm(data.uri, form, {
	 ...data.headers
	})
 } else {
	fileUrl = await uploadFile(data.uri, rf, {
	 ...data.headers
	})
 }
 return fileUrl
}

const uploadFileForm = async (url, args, config) => {
 let res = await axios.post(url, args, {
	headers: {
	 'Content-Type': 'multipart/form-data',
	 ...config
	}
 })
 return res.data
}
const uploadFile = async (url, args, config) => {
 let res = await axios.put(url, args, {
	headers: {
	 'Content-Type': 'multipart/form-data',
	 ...config
	}
 })
 return res.data
}
```

#### 二、引入使用

上传execl文件、解析二进制数据

```js
const file = await uploadFileEvent({
	accept: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
})
const data = await readBlobAsArrayBuffer(file)
```

上传pdf文件、请求接口获取上传服务器的链接、上传

```js
const { uri, node } = await uploadFileEvent({ accept: 'application/pdf', api: this.$api.question_set.upload, beforeUpload: {} })
```



#### 三、文件accept格式

| 文件格式 |  accept  |
|  ----  | ----  |
|  .3gpp	|  audio/3gpp, video/3gpp	          |
|  .ac3	  |  audio/ac3	          |
|  .asf	  |  allpication/vnd.ms-asf	          |
|  .au	  |  audio/basic	          |
|  .css   |  text/css	          |
|  .csv   |  text/csv	          |
|  .doc   |  application/msword	          |
|  .dot   |  application/msword	          |
|  .dtd   |  application/xml-dtd	          |
|  .dwg   |  image/vnd.dwg	          |
|  .dxf   |  image/vnd.dxf          |
|  .gif   |  image/gif          |
|  .htm   |  text/html          |
|  .html	|  text/html         |
|  .jp2	  |  image/jp2	          |
|  .jpe	  |  image/jpeg	          |
|  .jpeg	|  image/jpeg	          |
|  .jpg	  |  image/jpeg	          |
|  .js	  |  text/javascript,|  application/javascript	              |
|  .json	|  application/json              |
|  .mp2	  |  audio/mpeg, video/mpeg              |
|  .mp3	  |  audio/mpeg	              |
|  .mp4	  |  audio/mp4, video/mp4              |
|  .mpeg	|  video/mpeg              |
|  .mpg   |	video/mpeg              |
|  .mpp   |	application/vnd.ms-project              |
|  .ogg   |	application/ogg             |
|  .pdf   |	application/pdf             |
|  .png   |	image/png             |
|  .pot   |	application/vnd.ms-powerpoint	              |
|  .pps   |	application/vnd.ms-powerpoint	              |
|  .ppt   |	application/vnd.ms-powerpoint	              |
|  .rtf   |	application/rtf             |
|  .svf   |	image/vnd.svf	              |
|  .tif   |	image/tiff	              |
|  .tiff	|  image/tiff	              |
|  .txt   |	text/plain	              |
|  .wdb   |	application/vnd.ms-works              |
|  .wps   |	application/vnd.ms-works              |
|  .xhtml |	application/xhtml+xml	              |
|  .xlc   |	application/vnd.ms-excel              |
|  .xlm   |	application/vnd.ms-excel              |
|  .xls   |	application/vnd.ms-excel              |
|  .xlt   |	application/vnd.ms-excel              |
|  .xlw   |	application/vnd.ms-excel              |
|  .xml   |	text/xml,|  application/xml             |
|  .zip   |	aplication/zip	Compressed Archive              |
|  .xlsx  |  application/vnd.openxmlformats-officedocument.spreadsheetml.sheet              |
|  .xltx  |  application/vnd.openxmlformats-officedocument.spreadsheetml.template             |
|  .potx  |  application/vnd.openxmlformats-officedocument.presentationml.template              |
|  .ppsx  |  application/vnd.openxmlformats-officedocument.presentationml.slideshow             |
|  .pptx  |  application/vnd.openxmlformats-officedocument.presentationml.presentation              |
|  .sldx  |  application/vnd.openxmlformats-officedocument.presentationml.slide             |
|  .docx  |  application/vnd.openxmlformats-officedocument.wordprocessingml.document              |
|  .dotx  |  application/vnd.openxmlformats-officedocument.wordprocessingml.template              |
|  .xlsm  |  application/vnd.ms-excel.addin.macroEnabled.12       |
|  .xlsb  |  application/vnd.ms-excel.sheet.binary.macroEnabled.12        |


#### 四、后端接口返回blob数据前端下载导出

![](http://linmingqi.top/img/%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E7%9A%84blob%E7%BB%93%E6%9E%84.png)

<font color='blue'>接口请求responseType： arraybuffer | blob</font><font color='red'>（不设置responseType，导出的文件会无法打开报错，这里例举zip和xlsx）</font>

![](http://linmingqi.top/img/%E4%B8%8D%E8%AE%BE%E7%BD%AEresponseType%E6%8A%A5%E9%94%99.png)
![](http://linmingqi.top/img/%E4%B8%8D%E8%AE%BE%E7%BD%AEresponseType%E6%8A%A5%E9%94%99xlsx.png)

```ts
async _multiPartGet(url) {
	let res = await this.axios.get(url, {
		responseType: "arraybuffer",
	});
	return res.data;
}
```

<font color='blue'>利用a标签唤起浏览器下载</font>

```ts
/**
 * @description: 文件下载
 * @param {Blob} blob 参数1：blob对象
 * @param {string} name 参数2：文件名称，包含文件后缀
 * @return {*}
 */
const download = (res, name) => {
	const link = document.createElement('a'); 
	link.style.display = 'none'
	const blob = new Blob([res], { type: 'application/zip' })
	const url = URL.createObjectURL(blob); 
	link.href = url; 
	link.download = name; 
	document.body.appendChild(link); 
	link.click(); 
	document.body.removeChild(link); 
	URL.revokeObjectURL(url); 
},
```

<font color='blue'>使用示例：多个导出进行下载</font>

```js
// loading（element）
const loading = this.$loading({
	lock: true,
	text: '导出中',
	spinner: 'el-icon-loading'
})
// queueEvents下载队列
const queueEvents = this.multipleSelection.map(item => {
	return _multiPartGet('接口/' + item.id)
})
Promise.all(queueEvents)
 .then((res) => {
	res.forEach((item) => {
		this.download(item, '教材')
	})
 })
 .finally(() => {
	loading.close()
 })
```

<!-- more -->
