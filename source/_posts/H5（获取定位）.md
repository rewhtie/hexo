---
title: H5浏览器获取定位
data: 2022-10-22 12:00
tags: 
    - 三方库
    - H5
---

H5浏览器获取定位，采用了百度地图api获取定位，并且支付宝内置浏览器是需要调用alipayJSBridge获取定位的，各个定位方式获取到经纬度可能是不同的坐标系，需要封装一套方法进行转换

<!-- more -->

## H5 唤起定位软件

```js
/**
 * @param latitude|longitude 经纬度
 * @param stationName 定位地点名
 * @param stationAddress 定位地址
*/
goLocationPath(item) {
  window.location.href =
    "//api.map.baidu.com/marker?location=" +
    item.latitude +
    "," +
    item.longitude +
    "&title=" +
    item.stationName +
    "&content=" +
    item.stationAddress +
    "&output=html";
}
```

## 普通浏览器环境下 —— 加载百度地图api定位

```js
export const BMapInit = async () => {
  window.HOST_TYPE = "2"; // https域名百度定位的一个隐藏坑
  if (window.BMap) {
    return window.BMap;
  }

  await load("https://api.map.baidu.com/getscript?v=v3.0&ak=uUZas4GaaI6QalSTn8giR2rX"); // 加载百度地图script，看（·动态加载script·那篇文章）
  return window.BMap;
};

/**
 * 获取经纬度
 * @returns
 */
export const getLocation = async () => {
  // 识别在支付宝环境下
  if (window.navigator.userAgent.toLowerCase().match(/Alipay/i) == "alipay") {
    const { longitude, latitude } = await getCurrentLocation();
    const res = await gcj02tobd09(longitude, latitude);
    getQueryAdCodeFromBaidu(res);
  } else {
    await BMap();
  }
};

/**
 * 百度API获取经纬度
 * @returns
 */
export const BMap = async () => {
  try {
    const BMap = await BMapInit();
    const geolocation = new BMap.Geolocation();
    return new Promise((resolve, reject) => {
      geolocation.getCurrentPosition(
        async function (res) {
          if (res.latitude && res.longitude) {
            resolve(res);
          } else {
            reject(res);
          }
        },
        {
          enableHighAccuracy: true //指示浏览器获取高精度的位置，默认false
        }
      );
    });
  } catch (e) {
    console.log("BMap===err", e);
  }
};

```

## 支付宝浏览器环境下 —— alipayJSBridge内置方法获取定位([支付宝H5开放文档](https://myjsapi.alipay.com/jsapi/index.html))

```js
export const ready = (callback) => {
  // 如果jsbridge已经注入则直接调用
  if (window.AlipayJSBridge) {
    callback && callback();
  } else {
    // 如果没有注入则监听注入的事件
    document.addEventListener("AlipayJSBridgeReady", callback, false);
  }
};

export const getCurrentLocation = () => {
  return new Promise((resolve, reject) => {
    ready(function () {
      window.AlipayJSBridge.call(
        "getCurrentLocation",
        { bizType: "ensd" }, // 小写的英文字母
        async function (result) {
          if (result.error) {
            reject(result.errorMessage);
          }
          resolve(result);
        }
      );
    });
  });
};

```

## 获取的经纬度坐标系不同 —— 转化坐标系

```js
/**
 * Created by Wandergis on 2015/7/8.
 * 提供了百度坐标（BD09）、国测局坐标（火星坐标，GCJ02）、和WGS84坐标系之间的转换
 */

//定义一些常量
const x_PI = (3.14159265358979324 * 3000.0) / 180.0;
/**
 * 百度坐标系 (BD-09) 与 火星坐标系 (GCJ-02)的转换
 * 即 百度 转 谷歌、高德
 * @param bd_lon
 * @param bd_lat
 * @returns {*[]}
 */
export const bd09togcj02 = (bd_lon, bd_lat) => {
  var x_pi = (3.14159265358979324 * 3000.0) / 180.0;
  var x = bd_lon - 0.0065;
  var y = bd_lat - 0.006;
  var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_pi);
  var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_pi);
  var gg_lng = z * Math.cos(theta);
  var gg_lat = z * Math.sin(theta);
  return [gg_lng, gg_lat];
};

/**
 * 火星坐标系 (GCJ-02) 与百度坐标系 (BD-09) 的转换
 * 即谷歌、高德 转 百度
 * @param lng
 * @param lat
 * @returns {*{}}
 */
export const gcj02tobd09 = (lng, lat) => {
  var z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_PI);
  var theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_PI);
  var bd_lng = z * Math.cos(theta) + 0.0065;
  var bd_lat = z * Math.sin(theta) + 0.006;
  return {
    latitude: bd_lat,
    longitude: bd_lng
  };
};
```

<!-- more -->
