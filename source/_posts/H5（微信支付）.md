---
title: H5 微信支付
data: 2022-12-07 18:00
tags: H5
---

H5 微信支付有两种形式：微信扫码（微信内置浏览器环境）拉起公众号支付 ； 外部浏览器拉起微信小程序支付 


<!-- more -->

### 微信公众号支付
> 1、授权获取code，换取openid（微信有多个后台管理，包括小程序、公众号，所以不同主体下的openid是不一致的！）
2、引入微信内置jsBrige（SDK），配置wx.config
3、调起支付 内置方法chooseWXPay


<font color="red">1、授权方法</font>

```js
// 微信授权
const appId = "wxe6fa9461e432a2c1";
// 微信SDK静默授权（公众）
export const wxAuth = () => {
  const redirect = encodeURIComponent(location.href);
  let wxUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appId}&redirect_uri=${redirect}&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect`;
  location.href = wxUrl;
};
```

<font color="red">2、引入jsBrige，参考这篇文章（[动态加载script执行回调](http://lin-mingqi.gitee.io/linmingqi/2022/05/13/%E5%85%A8%E5%B1%80%EF%BC%88%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDscript%EF%BC%89/) ），配置wx.config安全验证</font>

识别环境加载微信sdk
```js
load('https://res2.wx.qq.com/open/js/jweixin-1.6.0.js')
```

获取config参数并且设置wx.config
```js
import axios from "axios";

// 获取config接口
export const getWeChatConfig = async (list = ["chooseWXPay"]) => {
  const { data } = await axios({
    method: "post",
    url:
      process.env.VUE_APP_BASE_URL +
      "/ensd-c-interface/wx/jsapi/wxe6fa9461e432a2c1/getJsapiSignature",
    data: {
      url: window.location.href
    },
    headers: { "content-type": "application/json" }
  });
  if (data.code === 200 || data.status === 200 || data.rs == 1) {
    await setWeChatConfig(data.data, list);
  }
};
// 设置wx.config ready传入方法
const setWeChatConfig = async (data, list) => {
  return new Promise((resolve) => {
    window.wx.config({
      debug: false,
      appId: data.appId || data.appid,
      timestamp: data.timestamp || data.timeStamp,
      nonceStr: data.nonceStr || data.noncestr,
      signature: data.signature || data.signature,
      jsApiList: ["checkJsApi", ...list]
    });
    window.wx.ready(function () {
      window.wx.checkJsApi({
        jsApiList: [...list],
        success: function () {
          // 方法已初始化挂载成功
          resolve();
        }
      });
    });
  });
};

export const weChatPay = (data) => {
  return new Promise((resolve, reject) => {
    window.wx.chooseWXPay({
      timestamp: data.timestamp, // 支付签名时间戳，注意微信 jssdk 中的所有使用 timestamp 字段均为小写。但最新版的支付后台生成签名使用的 timeStamp 字段名需大写其中的 S 字符
      nonceStr: data.nonceStr, // 支付签名随机串，不长于 32 位
      package: data.packageName, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
      signType: data.signType, // 微信支付V3的传入 RSA ,微信支付V2的传入格式与V2统一下单的签名格式保持一致
      paySign: data.sign, // 支付签名
      success: (success) => {
        resolve(true);
        // 因为微信现在已经收回点击完成跳转的回调事件了，详情了解点金计划
        console.log("支付成功后的回调函数payment", success);
      },
      cancel: (cancel) => {
        resolve(false);
        console.log("支付取消", cancel);
      },
      fail: (fail) => {
        reject(fail);
        console.log("fail支付失败了", fail);
        //支付失败
      }
    });
  });
};
```

<font color="red">3、调支付方法</font>

```js
const goWxPay = async (info) => {
  try {
    Toast.loading({
      duration: 0, // 持续展示 toast
      forbidClick: true
    });
    const params = {
      openid: storage.get("userInfo").openid, // 一般都需要传openid
      ...info 
    };
    // Promise.all参数是一个数组, 取数据记得用下标取对应的
    const list = await Promise.all([
      getWeChatConfig(["chooseWXPay"]),
      api.homePage.createOrderAndPay(params)
    ]);
    const data = list[1].data;
    const flag = await weChatPay(data);
    Toast && Toast.clear();
    if (flag) {
      console.log(flag);
    } else {
      // 取消订单接口
      await api.order.cancelOrder({
        orderId: data.bizNo
      });
    }
  } catch (err) {
    Toast && Toast.clear();
  }
};
```

### 微信小程序支付 （外部通过云函数跳转小程序）

>[静态网站H5打开小程序官网文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/staticstorage/jump-miniprogram.html)

![](http://linmingqi.top/img/%E9%9D%99%E6%80%81h5%E6%89%93%E5%BC%80%E5%B0%8F%E7%A8%8B%E5%BA%8F.png)

<font color="red">
问题一：微信扫码静态网站H5进行跳转小程序传参会丢失(不知道为啥会丢失)
</font>
<font color="blue">（解决：需要通过onload加载把参数挂载到节点上）</font>
```js
<script>
  window.onload = function() {
    document.getElementById("launch-btn").setAttribute("env-version", env_version);
    document.getElementById("launch-btn").setAttribute(`path`, `${path}?userId=${query.userId}`);
    document.getElementById("launch-btn").setAttribute("username", "gh_937f95394e6c");
  }
</script>
```
<font color="red">
问题二：静态网站H5进入小程序，小程序的场景值是1065，app移动应用打开场景值是1069，某种场景就是两种打开方式会混合使用，导致场景值污染无法准确识别
</font>

>[文档 — 打开微信小程序对应场景值](https://developers.weixin.qq.com/miniprogram/dev/reference/scene-list.html)
[文档 — 微信小程序获取场景值方法](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/life-cycle/wx.getEnterOptionsSync.html)

<font color="blue">解决：使用wx.getEnterOptionsSync()方法</font>

```js
onLoad(options) { 
  const { referrerInfo, scene } = wx.getEnterOptionsSync()
  console.log(scene, 'scene场景值')
}
```

<font color="#48c9b0">补充：这里涉及到小程序的冷启动和热启动的概念（后台最多两个小时），<font color="red">首次进入小程序冷启动会触发</font> app.js 中的 onLaunch 和 wx.getLaunchOptionsSync() ，<font color="red">后台切换进入是热启动不会触发</font> onLaunch 和 wx.getLaunchOptionsSync 了，要想获取第二次的数据只能通过 wx.getEnterOptionsSync() 获取</font>

<font color="red">问题三：静态网站H5跳转云函数页面打开小程序报错、异常(errCode 40165)</font>

![](http://linmingqi.top/img/%E4%BA%91%E5%87%BD%E6%95%B0%E5%BC%82%E5%B8%B8504002.png)

<font color="blue">（解决：小程序正式版必须已经有这个路径，没有就会报错）</font>

<font color="red">
问题四：小程序支付，只需要对应的api（wx.requestPayment）详细看文档</font>

>[wx.requestPayment](https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html)






<!-- more -->
