---
title: H5 支付宝支付
data: 2022-12-07 18:00
tags: H5
---

H5支付宝支付有两种形式：支付宝扫码拉起生活号支付（支付宝内置浏览器环境） ； 外部浏览器拉起支付宝h5支付 

<!-- more -->

>一些相关的官网文档，支付宝的文档真心不咋滴，又多又杂，找不到北的感觉
[支付宝支付流程图](https://opendocs.alipay.com/open/203/105285)
[支付失败详细的resultCode对应码](https://myjsapi.alipay.com/alipayjsapi/util/pay/tradePay.html)
[tradePay支付方法](https://myjsapi.alipay.com/alipayjsapi/util/pay/tradePay.html)

### 支付宝扫码拉起生活号支付（当面付）
> 1、授权获取code，换取openid（支付宝只有一个后台管理，包括小程序、生活号，所以不同主体下的openid是一致的！）
2、引入支付宝内置jsBrige，调支付方法
3、调起支付 内置方法tradePay

<font color="red">1、授权方法</font>
```js
const aliAppId = process.env.VUE_APP_ALI_APPID || "2021003156646387";
// 支付宝SDK静默授权（公众）
export const aliAuth = () => {
  const redirect = encodeURIComponent(location.href);
  let aliUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=${aliAppId}&scope=auth_base&redirect_uri=${redirect}`;
  location.href = aliUrl;
};
```

<font color="red">2、引入jsBrige，参考这篇文章（[动态加载script执行回调](http://lin-mingqi.gitee.io/linmingqi/2022/05/13/%E5%85%A8%E5%B1%80%EF%BC%88%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDscript%EF%BC%89/) ）</font>

```js
load('https://appx/web-view.min.js')
export const ready = (callback) => {
  // 如果jsbridge已经注入则直接调用
  if (window.AlipayJSBridge) {
    callback && callback();
  } else {
    // 如果没有注入则监听注入的事件
    document.addEventListener("AlipayJSBridgeReady", callback, false);
  }
};

```

<font color="red">3、调支付方法tradePay</font>

```js
const goAliPay = async (info) => {
  Toast.loading({
    duration: 0, // 持续展示 toast
    forbidClick: true
  });
  const params = {
    openid: storage.get("userInfo").aliUserId,
    ...info  // 创建订单所需的参数，创建订单必须会需要aliUserId
  };
  try {
    const { data } = await api.homePage.createOrderAndPay(params); // 创建订单接口
    ready(() => {
      window.AlipayJSBridge.call(
        "tradePay",
        {
          tradeNO: data.tradeNo
        },
        async function (res) {
          if (res.resultCode === "9000") {
            // 支付成功，需要回调跳转，或者做一些页面刷新的动作
            location.href = `./payment?bizNo=${data.bizNo}&payOrderNo=${data.payOrderNo}`;
            return;
          } else {
            // 支付失败，包括拉起支付控件点X取消支付(6001)，
            await api.order.cancelOrder({
              // 取消支付这时会取消这笔订单,业务场景需要
              orderId: data.bizNo
            });
          }
        }
      );
    });
  } catch (err) {
    console.log(err);
  }
  Toast && Toast.clear();
};
```

### 外部浏览器拉起支付宝支付（直接document.write后端接口返回的支付表单）
```js
const goAliH5Pay = async (info) => {
  Toast.loading({
    duration: 0, // 持续展示 toast
    forbidClick: true
  });
  const params = {
    ...info 
  };
  try {
    const { data } = await api.homePage.createOrderAndPay(params); // 创建订单接口
    Toast.clear(); 
    document.write(data.appPayBody);
  } catch (err) {
    Toast.clear();
  }
};
```

><font color="red">注意：最简单的加载样式就是vant提供的loading组件，h5是一步步递进的，但是也有回退的时候，所以最好是复原页面的状态再进行跳转</font>

<!-- more -->
