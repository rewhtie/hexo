---
title: H5 微信授权
data: 2021-11-29 11：19：00
tags: 
	- H5
---

微信授权有两种，一种是静默授权、一种是手动授权（一般用于微信卡包，领卷，根据用户的唯一标识来判断领券状态）

<!-- more -->

####    
[官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html) 详情看官方文档

<font color="#08c">1.需要公众号的appid</font>

<font color="#08c">2.微信开发者者权限</font>

<font color="#08c">3.一定要先关注绑定的公众号</font>

<font color="#08c">4.生态都是完整的，我们只需要跟着来就行了</font>

```js
getWeiXinImpower() {
    let appid = ""; //公众号唯一标识
    let REDIRECT_URI = ""; //重定向地址
    window.location.relpace(`https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${REDIRECT_URI}&code=CODE&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect`);
}
// 授权之后选择跳转回来的地址,code参数一般会有时效性的
```
</br>
<font color="#08c"> 5.微信授权之后的链接是会携带参数的，我们分享时的链接是会带上用户参数的，记得要把链接上的参数去掉。</font>
<font color="#08c"> 6.微信授权重定向之后带来的问题</font>

首先，我们需要理解，微信授权重定向、微信浏览器里会记录有未授权的页面和已授权的页面，这时要关闭页面时需要连续快速点击两次返回才会正常关闭页面

先引入微信的js包
```js
<script src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js" type="text/javascript" charset="utf-8"></script>
wx.closeWindow() //引用关闭微信的h5页面事件（整个进程关掉会把其他页面也给干掉）
```

ios微信下，是有回退和前进的按钮，回退和前进是不会重新刷新页面的，这时就会引发一些业务上的问题。例如：返回的时候未授权的页面不会进行重定向了，一直卡在未授权页面，这时用户体验上就有bug
```js
window.addEventListener('pageshow', (e) => {
    if (e.persisted || (window.performance && window.performance.navigation.type === 2)) {
        // 页面后退时操作：记录返回时间
        window.location.reload()
    }
})
这样监听ios微信的回退按钮，达到刷新页面的作用
```

安卓微信下，返回是会自动刷新页面的，相比较ios就少一部监听回退的动作

解决微信重定向授权返回需要点击两次的问题：
```js
function isWeiXinImpower(){
    if (sessionStorage.getItem('code')){
        wx.closeWindow()
    }
    if(getUrlParam('code')){  //getUrlParam()是截取地址栏参数的方法
        sessionStorage.setItem('code', getUrlParam('code'));
    } else {
        getWeiXinImpower()
    }
}
```
判断地址栏code参数，有code的保存到sessionStorage中，无code走授权重定向，之后进入会再走一层判断，判断这个页面是否有code的sessionStorage，其实无授权的页面和有授权的页面（都是同一个页面，带不带code参数而已）都能找到这个code的sessionStorage，这点很重要，所以会话中有code的我们就会关闭微信浏览器，实现返回一次直接退出页面的

有些场景不兼容：假如h5跳h5，这种情况会把所有h5都给直接干掉了

<!-- more -->
